<!-- products/templates/products/product_list.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/product_list.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Ø¥Ø¶Ø§ÙØ© jQuery -->
{% endblock %}

{% block content %}
    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ -->

    <!-- ØªØ­Ø¯ÙŠØ« Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©" Ù„ÙŠØ´Ù…Ù„ Ø®Ø§ØµÙŠØ© onclick -->
    {% for category in categories %}
        <section class="category-section {% if forloop.first %}mt-5{% endif %}">
            <div class="container">
                <h1>{{ category.name }}</h1>
                <hr class="products-hr">
                <div class="grid-layout mt-4">
                    {% for product in category.products.all %}
                        <div class="card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'100' }}">
                            <div class="card-image-container">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="card-img">
                                {% else %}
                                    <img src="{% static 'images/no-image-available.jpg' %}" alt="No Image" class="card-img">
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">{{ product.description|truncatewords:20 }}</p>
                                <p class="price">{{ product.price }} Ø´ÙŠÙƒÙ„</p>
                                <div class="btn-group">
                                    <button 
                                        class="btn btn-danger add-to-cart-btn" 
                                        data-product-id="{{ product.pk }}" 
                                        data-product-name="{{ product.name }}" 
                                        data-product-price="{{ product.price }}"
                                    >
                                        Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
                                    </button>
                                    <a href="{% url 'product-detail' product.pk %}" class="btn btn-primary">ØªÙØ§ØµÙŠÙ„</a>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.</p>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% endfor %}

    <!-- Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
    <br><br>
    <h4 class="sry-msg">Uh-Oh! We are <span class="colored-word">done</span> ğŸ›’</h4> 
    <hr class="last-hr-of-product">
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function(){
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† CSRF Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ²
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Ù‡Ù„ Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŸ
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Ø¥Ø¹Ø¯Ø§Ø¯ AJAX Ù„ØªØ¶Ù…ÙŠÙ† ØªÙˆÙƒÙ† CSRF ÙÙŠ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // ÙÙ‚Ø· Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù†Ù‚Ø± Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©"
        $('.add-to-cart-btn').click(function(){
            const productId = $(this).data('product-id');
            $.ajax({
                url: "{% url 'add-to-cart' 0 %}".replace('/0/', '/' + productId + '/'),
                type: 'POST',
                data: {
                    'product_id': productId
                },
                success: function(response){
                    if(response.status === 'success'){
                        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙŠÙÙŠØ© Ø¹Ø±Ø¶Ùƒ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±)
                        $('#cart-count').text(response.cart_count);
                        alert(response.message || 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                    } else {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©.');
                    }
                },
                error: function(){
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
                }
            });
        });
    });
</script>
{% endblock %}
